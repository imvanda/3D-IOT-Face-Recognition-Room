version: '3.8'

services:
  # 1. ThingsBoard: 核心物联网平台
  thingsboard:
    image: thingsboard/tb-postgres
    container_name: my-tb-platform
    ports:
      - "8080:9090"  # HTTP Web UI
      - "1883:1883"  # MQTT 端口
    volumes:
      - tb-data-volume:/data
    restart: always
    environment:
      - TB_QUEUE_TYPE=in-memory
    networks:
      - iot-network

  # 2. Node-RED: 后端逻辑加工厂
  nodered:
    image: nodered/node-red:latest
    container_name: my-node-red
    ports:
      - "1880:1880"
    volumes:
      # 【关键修正】挂载整个目录而非单个文件，避免 EBUSY 锁定
      # 宿主机的 ./nodered-data 会包含 flows.json 和所有插件
      - ./nodered-data:/data
    depends_on:
      - thingsboard
      - mosquitto
    restart: always
    networks:
      - iot-network

  # 3. Mosquitto: 独立 MQTT Broker (用于 3D 前端 WS 连接)
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: my-mqtt-broker
    ports:
      - "1884:1883"  # 避开 ThingsBoard 的 1883
      - "9001:9001"  # WebSocket 端口，供前端 3D 房间连接
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto-data-volume:/mosquitto/data
    restart: always
    networks:
      - iot-network

# 卷定义
volumes:
  tb-data-volume:
  mosquitto-data-volume:
  # node-red 使用了本地目录挂载，此处可删掉命名卷

networks:
  iot-network:
    driver: bridge
    name: iot-network