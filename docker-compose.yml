services:
  # 1. ThingsBoard: 核心物联网平台
  thingsboard:
    image: thingsboard/tb-postgres
    container_name: my-tb-platform
    ports:
      - "8080:9090"  # HTTP Web UI
      - "1883:1883"  # MQTT 端口
    volumes:
      - tb-data-volume:/data
    restart: always
    environment:
      - TB_QUEUE_TYPE=in-memory
    networks:
      - iot-network

  # 2. Node-RED: 后端逻辑加工厂
  nodered:
    image: nodered/node-red:latest
    container_name: my-node-red
    ports:
      - "1880:1880"
    volumes:
      # 【关键修正】挂载整个目录而非单个文件，避免 EBUSY 锁定
      # 宿主机的 ./nodered-data 会包含 flows.json 和所有插件
      - ./nodered-data:/data
    depends_on:
      - thingsboard
      - mosquitto
    restart: always
    networks:
      - iot-network

  # 3. Mosquitto: 独立 MQTT Broker (用于 3D 前端 WS 连接)
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: my-mqtt-broker
    ports:
      - "1884:1883"  # 避开 ThingsBoard 的 1883
      - "9001:9001"  # WebSocket 端口，供前端 3D 房间连接
    volumes:
      - ./mosquitto/config/mosquitto.conf:/mosquitto/config/mosquitto.conf
      - mosquitto-data-volume:/mosquitto/data
    restart: always
    networks:
      - iot-network

  # 4. Django Backend: AI 识别服务 (人脸+手势)
  django-backend:
    build:
      context: ./django-backend
      dockerfile: Dockerfile
    container_name: smartroom-django-backend
    ports:
      - "8000:8000"
    volumes:
      - ./django-backend/media:/app/media
      - ./mediapipe/hand_landmarker.task:/app/hand_landmarker.task
    environment:
      - DEBUG=True
      - DJANGO_SECRET_KEY=django-insecure-smartroom-dev-key-change-in-production
      - ALLOWED_HOSTS=localhost,127.0.0.1,0.0.0.0
      - CORS_ALLOWED_ORIGINS=http://localhost:3000,http://localhost:5173
      - DEEPFACE_MODEL=VGG-Face
      - DEEPFACE_DISTANCE_METRIC=cosine
      - FACE_RECOGNITION_THRESHOLD=0.4
      - MAX_HANDS=2
      - MIN_DETECTION_CONFIDENCE=0.6
      - MIN_TRACKING_CONFIDENCE=0.6
      # MySQL配置
      - DB_ENGINE=mysql
      - DB_HOST=mysql
      - DB_PORT=3306
      - DB_NAME=smartroom
      - DB_USER=root
      - DB_PASSWORD=1234
    depends_on:
      - mysql
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/api/v1/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s
    networks:
      - iot-network

  # 5. MySQL数据库
  mysql:
    image: mysql:8.0
    container_name: smartroom-mysql
    ports:
      - "3307:3306"
    volumes:
      - mysql-data:/var/lib/mysql
      - ./mysql/init.sql:/docker-entrypoint-initdb.d/init.sql
    environment:
      - MYSQL_ROOT_PASSWORD=1234
      - MYSQL_DATABASE=smartroom
      - MYSQL_CHARACTER_SET_SERVER=utf8mb4
      - MYSQL_COLLATION_SERVER=utf8mb4_unicode_ci
    restart: unless-stopped
    networks:
      - iot-network

# 卷定义
volumes:
  tb-data-volume:
  mosquitto-data-volume:
  mysql-data:
  # node-red 使用了本地目录挂载，此处可删掉命名卷

networks:
  iot-network:
    driver: bridge
    name: iot-network